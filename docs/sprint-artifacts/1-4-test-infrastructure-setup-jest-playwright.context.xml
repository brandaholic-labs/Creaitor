<story-context id="1-4-test-infrastructure-setup-jest-playwright" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>Test Infrastructure Setup (Jest + Playwright)</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-19</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-4-test-infrastructure-setup-jest-playwright.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>Jest for unit/integration tests and Playwright for E2E tests configured</iWant>
    <soThat>we can write tests following Test Design document strategy (40% unit, 30% integration, 30% E2E)</soThat>
    <tasks>
      - Task 1: Jest konfiguráció létrehozása (AC: #1)
      - Task 2: Playwright konfiguráció létrehozása (AC: #2)
      - Task 3: package.json scripts hozzáadása (AC: #3)
      - Task 4: Example tesztek létrehozása (AC: #4)
      - Task 5: Test utilities és fixtures létrehozása (AC: #1, #2)
      - Task 6: CI/CD integráció előkészítése (AC: #1, #2, #3)
      - Task 7: Dokumentáció és validation (AC: #1, #2, #3, #4)
    </tasks>
  </story>

  <acceptanceCriteria>
    AC1: Jest is configured for unit and integration tests
    - TypeScript support (@swc/jest for fast compilation)
    - React Testing Library integration
    - Module path aliases matching tsconfig.json
    - Coverage reporting (target: ≥80% critical paths)

    AC2: Playwright is configured for E2E tests
    - Browser engines installed (Chromium, Firefox, WebKit)
    - Test fixtures for authentication
    - Screenshot/video capture on failure
    - Parallel test execution

    AC3: package.json scripts exist
    - npm run test:unit (Jest unit tests)
    - npm run test:integration (Jest integration tests)
    - npm run test:e2e (Playwright E2E tests)
    - npm run test:coverage (coverage report)

    AC4: Example tests exist
    - tests/unit/example.test.ts (unit test example)
    - tests/integration/api/example.test.ts (API integration test example)
    - tests/e2e/example.spec.ts (E2E test example)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/sprint-artifacts/tech-spec-epic-1.md" title="Tech Spec Epic 1" section="Story 1.4 Acceptance Criteria (lines 1143-1152), Test Strategy Summary (lines 1400-1470)">
        Definíciója a test infrastruktúra acceptance criteria-kat és test strategy összefoglalót: Jest unit/integration, Playwright E2E, coverage targets (≥60% P0 baseline), test pyramid (40% unit, 30% integration, 30% E2E).
      </doc>
      <doc path="docs/test-design-system.md" title="Test Design Document" section="Teszt Szintek Stratégia, Test Coverage Plan">
        Test strategy dokumentum tesztelhetőség értékeléssel: Kontrollálhatóság PASS, Megfigyelhetőség PASS, Megbízhatóság CONCERNS. Coverage célok: ≥80% kritikus útvonalak (unit), ≥70% API endpointok (integráció), ≥50% kritikus útvonalak (E2E).
      </doc>
      <doc path="docs/epics/epic-1-foundation-development-infrastructure.md" title="Epic 1 Story Breakdown" section="Story 1.4">
        Story áttekintés és technical notes: Follow Test Design document coverage targets, use @testing-library/react for component testing, use MSW for API mocking, Playwright baseURL http://localhost:3000.
      </doc>
      <doc path="docs/sprint-artifacts/1-4-test-infrastructure-setup-jest-playwright.md" title="Story 1.4 Markdown" section="Dev Notes, Tasks/Subtasks">
        Detailed task breakdown: 7 main tasks with subtasks, architecture constraints (Testing Strategy Pattern), test file structure, Jest/Playwright configuration patterns, learnings from Story 1.3.
      </doc>
    </docs>
    <code>
      <!-- No existing test code yet - this story creates the infrastructure -->
    </code>
    <dependencies>
      <node>
        <package name="jest" version="^29.7.0" type="devDependency">Jest test framework for unit and integration tests</package>
        <package name="@swc/jest" version="^0.2.29" type="devDependency">Fast TypeScript compilation for Jest</package>
        <package name="@testing-library/react" version="^14.1.2" type="devDependency">React component testing utilities</package>
        <package name="@testing-library/jest-dom" version="^6.1.5" type="devDependency">Custom Jest matchers for DOM assertions</package>
        <package name="@playwright/test" version="^1.40.1" type="devDependency">Playwright E2E test framework</package>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    Architecture Constraints:
    - Testing Strategy Pattern: Unit tests (Jest, mocked AI), Integration tests (Jest + Supertest), E2E tests (Playwright, critical flows)
    - Test Pyramid: 40% unit, 30% integration, 30% E2E coverage target
    - Coverage target: ≥60% (P0 pilot baseline), ≥80% critical paths
    - Test file structure: tests/unit/, tests/integration/api/, tests/e2e/
    - Jest config: TypeScript support (@swc/jest), module aliases match tsconfig.json, coverage threshold ≥80% critical paths
    - Playwright config: Base URL http://localhost:3000, test isolation (each test resets state), retry policy 1x, timeout 30s action timeout
    - No live API calls in unit tests (AI responses mocked)
    - CI/CD integration: Jest works in CI environment, Playwright works in headless mode
  </constraints>

  <interfaces>
    <!-- No existing interfaces yet - this story creates the test infrastructure -->
  </interfaces>

  <tests>
    <standards>
      Test standards extracted from Test Design Document and Tech Spec:
      - Framework: Jest for unit/integration, Playwright for E2E
      - Coverage: ≥60% total (P0 baseline), ≥80% critical paths (unit), ≥70% API endpoints (integration), ≥50% critical flows (E2E)
      - Test pyramid: 40% unit, 30% integration, 30% E2E
      - Execution: Development pre-commit (unit tests < 10s), CI pipeline (unit + integration + coverage), CD pipeline (E2E smoke tests < 2 min)
      - Flaky test mitigation: Playwright retry 1x, generous timeout (30s), test isolation, deterministic fixtures
    </standards>
    <locations>
      Test directories (to be created):
      - tests/unit/ (Jest unit tests)
      - tests/integration/api/ (Jest integration tests for API routes)
      - tests/e2e/ (Playwright E2E tests)
      - tests/utils/ (Test utilities: mockSupabase.ts, mockAI.ts, testFixtures.ts)
      - tests/setup.ts (Jest setup file with jest-dom matchers)
      Configuration files:
      - jest.config.js (Jest configuration)
      - playwright.config.ts (Playwright configuration)
      - package.json (Test scripts: test:unit, test:integration, test:e2e, test:coverage)
    </locations>
    <ideas>
      Test ideas mapped to acceptance criteria:
      - AC1: Verify Jest config with @swc/jest TypeScript support, test module path aliases resolve correctly, coverage report generates with ≥80% threshold for critical paths
      - AC2: Verify Playwright config with all browser engines (Chromium, Firefox, WebKit), test fixtures structure exists, screenshot/video capture works on test failure
      - AC3: Verify all npm scripts (test:unit, test:integration, test:e2e, test:coverage) execute successfully, scripts match expected patterns
      - AC4: Verify example tests exist and run successfully: unit example (utility function), integration example (API route), E2E example (navigation flow)
    </ideas>
  </tests>
</story-context>

