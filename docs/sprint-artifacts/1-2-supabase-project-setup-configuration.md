# Story 1.2: Supabase Project Setup & Configuration

Status: drafted

## Story

As a **developer**,
I want **Supabase local instance configured with PostgreSQL database, Auth service, and Storage**,
so that **we have a working database backend for multi-tenant data and authentication**.

## Requirements Context

Ez a story a Creaitor adatbÃ¡zis infrastruktÃºrÃ¡jÃ¡t hozza lÃ©tre. Az **Epic 1: Foundation & Development Infrastructure** mÃ¡sodik lÃ©pÃ©sekÃ©nt lÃ©trehozza a Supabase kÃ¶rnyezetet lokÃ¡lis fejlesztÃ©shez Ã©s cloud production-hÃ¶z.

**Ãœzleti indoklÃ¡s:** MÅ±kÃ¶dÅ‘ backend adatbÃ¡zis biztosÃ­tÃ¡sa multi-tenant adatkezelÃ©shez, autentikÃ¡ciÃ³hoz Ã©s fÃ¡jltÃ¡rolÃ¡shoz. Supabase PostgreSQL Row-Level Security (RLS) policies garantÃ¡ljÃ¡k, hogy minden agency csak a sajÃ¡t adatait lÃ¡tja.

**KapcsolÃ³dÃ¡s az architektÃºrÃ¡hoz:**
- **Architecture Decision ADR-002:** Supabase over Firebase/AWS (PostgreSQL relational DB, RLS multi-tenancy, Auth + Storage beÃ©pÃ­tve)
- **Architecture Â§ Data Architecture - Core Entities:** Initial database schema migration (agencies, users, brands, brand_brain_entries, social_profiles, posts, usage_events)
- **Architecture Â§ Supabase Setup (lines 399-407):** Supabase client singleton pattern, browser-side Ã©s server-side clients

**PRD Requirements lefedettsÃ©g:**
- **TA2: Technology Stack Decisions - Backend Stack:** Supabase PostgreSQL + Auth + Storage
- **TA3: Data Model - Single Source of Truth:** Core entities schema (agencies, users, brands, posts)
- **NFR2: Security - Multi-tenant Isolation:** RLS policies (schema lÃ©trehozva, de Epic 2-ben enablelve)

**Tech Spec Epic 1 hivatkozÃ¡s:**
- [Source: docs/sprint-artifacts/tech-spec-epic-1.md Â§ Story 1.2 Acceptance Criteria (lines 1115-1127)]
- [Source: docs/sprint-artifacts/tech-spec-epic-1.md Â§ Data Models and Contracts (lines 182-320)]

## Acceptance Criteria

1. **AC1: LokÃ¡lis Supabase instance fut**
   - PostgreSQL database running (localhost:54322)
   - Auth service enabled (Supabase Auth)
   - Storage service enabled (S3-compatible storage)
   - Supabase Studio dashboard accessible (http://localhost:54323)

2. **AC2: `supabase/` directory struktÃºra lÃ©tezik**
   - `supabase/migrations/` - Database migration fÃ¡jlok
   - `supabase/seed.sql` - Test seed data (optional, placeholder)
   - `supabase/config.toml` - Supabase config (generated by `supabase init`)

3. **AC3: Environment variables konfigurÃ¡lva `.env.local` fÃ¡jlban**
   - `NEXT_PUBLIC_SUPABASE_URL` - Supabase project URL (local: http://localhost:54321)
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Public anon key (safe for client-side)
   - `SUPABASE_SERVICE_ROLE_KEY` - Service role key (server-side only, secret)

4. **AC4: Supabase client singleton lÃ©trehozva `src/lib/supabase/` mappÃ¡ban**
   - `src/lib/supabase/client.ts` - Browser-side client (SSR support with @supabase/ssr)
   - `src/lib/supabase/server.ts` - Server-side client (Route Handlers, Server Actions)
   - `src/lib/supabase/middleware.ts` - Auth middleware (Next.js middleware integration)

5. **AC5: Initial database schema migration (001_initial_schema.sql) lÃ©tezik**
   - **Tables created:** agencies, users, brands, brand_brain_entries, social_profiles, posts, usage_events
   - **Enums created:** post_status, usability_rating
   - **Indexes created:** idx_posts_brand_id, idx_posts_status, idx_posts_scheduled_at, idx_brands_agency_id, idx_users_agency_id
   - **RLS policies:** Schema tartalmazza RLS policy placeholder-eket, de **DISABLED** (Epic 2-ben enablelve)
   - Migration applied successfully: `npx supabase db push` (local)

## Tasks / Subtasks

- [ ] **Task 1: Supabase CLI telepÃ­tÃ©se Ã©s inicializÃ¡lÃ¡s** (AC: #1, #2)
  - [ ] Subtask 1.1: TelepÃ­tÃ©s: `npm install -D supabase` (dev dependency)
  - [ ] Subtask 1.2: Supabase inicializÃ¡lÃ¡s: `npx supabase init`
  - [ ] Subtask 1.3: Verify `supabase/` directory created (config.toml, migrations/ folder)
  - [ ] Subtask 1.4: Start Supabase local: `npx supabase start`
  - [ ] Subtask 1.5: Verify services running (PostgreSQL port 54322, Studio port 54323)
  - [ ] Subtask 1.6: Open Supabase Studio: http://localhost:54323 (verify dashboard loads)

- [ ] **Task 2: Environment variables setup** (AC: #3)
  - [ ] Subtask 2.1: Create `.env.local` file in project root
  - [ ] Subtask 2.2: Copy Supabase connection details from `npx supabase status` output
  - [ ] Subtask 2.3: Add `NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321` (or cloud URL)
  - [ ] Subtask 2.4: Add `NEXT_PUBLIC_SUPABASE_ANON_KEY=<anon_key>`
  - [ ] Subtask 2.5: Add `SUPABASE_SERVICE_ROLE_KEY=<service_role_key>` (SECRET - server only)
  - [ ] Subtask 2.6: Create `.env.example` file (template without actual keys)
  - [ ] Subtask 2.7: Update `.gitignore` to exclude `.env.local` (verify already present from Story 1.1)

- [ ] **Task 3: Supabase client singleton implementation** (AC: #4)
  - [ ] Subtask 3.1: Create `src/lib/supabase/` directory
  - [ ] Subtask 3.2: Implement `src/lib/supabase/client.ts` (browser-side client with @supabase/ssr)
  - [ ] Subtask 3.3: Implement `src/lib/supabase/server.ts` (server-side client for Route Handlers)
  - [ ] Subtask 3.4: Implement `src/lib/supabase/middleware.ts` (auth middleware for Next.js)
  - [ ] Subtask 3.5: Export helper functions: `createClient()`, `createServerClient()`, `createMiddlewareClient()`
  - [ ] Subtask 3.6: Test client initialization (manual test: import in a test file, verify no errors)

- [ ] **Task 4: Initial database schema migration** (AC: #5)
  - [ ] Subtask 4.1: Create migration: `npx supabase migration new initial_schema`
  - [ ] Subtask 4.2: Write `001_initial_schema.sql` with core tables:
    - agencies (id, name, created_at, updated_at)
    - users (id, agency_id, email, full_name, role, created_at)
    - brands (id, agency_id, name, description, is_active, created_at, updated_at)
    - brand_brain_entries (id, brand_id, tone_of_voice, key_messages[], example_posts[], visual_direction, taboos[], UNIQUE(brand_id))
    - social_profiles (id, brand_id, platform, platform_user_id, access_token, token_expires_at)
    - posts (id, brand_id, created_by, brief, generated_text, final_text, image_url, is_ai_generated, ai_usability_rating, ai_provider, platform, status, scheduled_at, published_at, meta_post_id, error_message, retry_count, CHECK constraint for ai_rating)
    - usage_events (id, user_id, agency_id, event_type, event_metadata JSONB, created_at)
  - [ ] Subtask 4.3: Create enums: `post_status`, `usability_rating`
  - [ ] Subtask 4.4: Create indexes: idx_posts_brand_id, idx_posts_status, idx_posts_scheduled_at, idx_brands_agency_id, idx_users_agency_id
  - [ ] Subtask 4.5: Add RLS policy placeholders (DISABLED, commented out - Epic 2 will enable)
  - [ ] Subtask 4.6: Apply migration: `npx supabase db push` (local)
  - [ ] Subtask 4.7: Verify tables created in Supabase Studio (http://localhost:54323/project/default/editor)

- [ ] **Task 5: TypeScript type generation** (AC: #5)
  - [ ] Subtask 5.1: Generate types from database schema: `npx supabase gen types typescript --local > src/types/database.types.ts`
  - [ ] Subtask 5.2: Verify `src/types/database.types.ts` contains all table types (Database, Tables, Enums)
  - [ ] Subtask 5.3: Create `src/types/index.ts` with manual type exports (PostStatus, UsabilityRating, UserRole, Platform)
  - [ ] Subtask 5.4: Import and verify types in a test file (manual test: no TypeScript errors)

- [ ] **Task 6: Validation Ã©s documentation** (AC: #1, #2, #3, #4, #5)
  - [ ] Subtask 6.1: Test Supabase client connection (create test API route: GET /api/test-db)
  - [ ] Subtask 6.2: Query test: `SELECT * FROM agencies LIMIT 1` (should return empty array, no errors)
  - [ ] Subtask 6.3: Verify TypeScript compilation: `npx tsc --noEmit` (no errors)
  - [ ] Subtask 6.4: Update README.md with Supabase setup instructions (Prerequisites section)
  - [ ] Subtask 6.5: Document Supabase commands (start, stop, reset, migration workflow)
  - [ ] Subtask 6.6: Commit changes: `git add . && git commit -m "feat(epic-1): Story 1.2 - Supabase project setup & configuration"`

## Dev Notes

### Architecture Constraints

**Supabase Setup Pattern (Architecture Â§ Supabase, lines 399-407):**
- **Database:** PostgreSQL 15 (Supabase managed)
- **Auth:** Supabase Auth (email/password + OAuth providers support)
- **Storage:** S3-compatible object storage (later Epic 4 for brand assets, post images)
- **Real-time:** Supabase Realtime (opcionÃ¡lis, kÃ©sÅ‘bbi collaborative editing-hez)
- **Row Level Security (RLS):** Multi-tenant data isolation (Epic 2 enables policies)

**Client Pattern (Singleton with SSR support):**
```typescript
// src/lib/supabase/client.ts
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}

// src/lib/supabase/server.ts
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export function createServerSupabaseClient() {
  const cookieStore = cookies()

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value
        },
      },
    }
  )
}
```

**Database Schema Constraints (Architecture Â§ Data Architecture, lines 1119-1233):**
- **UUID Primary Keys:** All tables use UUID (not auto-increment integers)
- **Timestamps:** `created_at`, `updated_at` with TIMESTAMPTZ (UTC storage)
- **Foreign Keys:** Cascade delete where appropriate (brand_brain_entries â†’ brands, posts â†’ brands)
- **Check Constraints:** Mandatory AI rating constraint (Pattern 4: Mandatory Usability Rating)

**RLS Policies Strategy (Epic 1 vs Epic 2):**
- **Epic 1 (Story 1.2):** Schema migration tartalmazza RLS policy SQL-t, de **COMMENTED OUT / DISABLED**
- **Epic 2 (Story 2.3):** RLS policies **ENABLE**-elÃ©se Ã©s tesztelÃ©se
- **Rationale:** Epic 1 infrastructure setup, Epic 2 authentication & authorization

### Testing Strategy

**Story 1.2 Testing (Tech Spec Â§ Test Coverage Targets):**
- **Unit tests:** Supabase client config test (~40% coverage)
- **Integration tests:** Supabase connection test, DB schema validation (~70% coverage)
- **E2E tests:** Nincs (mÃ©g nincs feature UI)
- **Manual testing checklist:**
  - [ ] Supabase local services running: `npx supabase status`
  - [ ] Database migration applied: Tables visible in Supabase Studio
  - [ ] Supabase client connection test: Test API route returns data
  - [ ] TypeScript types generated: No compilation errors

**Integration Test Example (Story 1.4 implementÃ¡lja):**
```typescript
// tests/integration/supabase.test.ts
import { createClient } from '@/lib/supabase/client'

describe('Supabase Connection', () => {
  it('should connect to Supabase', async () => {
    const supabase = createClient()
    const { data, error } = await supabase.from('agencies').select('*').limit(1)

    expect(error).toBeNull()
    expect(data).toEqual([]) // Empty array (no seed data yet)
  })
})
```

### Project Structure Notes

**Architecture Compliance (Architecture Â§ Project Structure):**

```
creaitor/
â”œâ”€â”€ supabase/                      # ğŸ†• Task 1 (Supabase init)
â”‚   â”œâ”€â”€ config.toml                # ğŸ†• Supabase config (auto-generated)
â”‚   â”œâ”€â”€ migrations/                # ğŸ†• Database migrations
â”‚   â”‚   â””â”€â”€ 20250119000000_initial_schema.sql  # ğŸ†• Task 4
â”‚   â””â”€â”€ seed.sql                   # ğŸ†• Placeholder (optional)
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ supabase/              # ğŸ†• Task 3
â”‚   â”‚       â”œâ”€â”€ client.ts          # ğŸ†• Browser-side client
â”‚   â”‚       â”œâ”€â”€ server.ts          # ğŸ†• Server-side client
â”‚   â”‚       â””â”€â”€ middleware.ts      # ğŸ†• Auth middleware
â”‚   â”‚
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”œâ”€â”€ database.types.ts      # ğŸ†• Task 5 (auto-generated)
â”‚   â”‚   â””â”€â”€ index.ts               # ğŸ”„ Updated (manual type exports)
â”‚   â”‚
â”‚   â””â”€â”€ app/
â”‚       â””â”€â”€ api/
â”‚           â””â”€â”€ test-db/           # ğŸ†• Task 6 (validation test route)
â”‚               â””â”€â”€ route.ts
â”‚
â”œâ”€â”€ .env.local                     # ğŸ†• Task 2 (SECRET - not committed)
â”œâ”€â”€ .env.example                   # ğŸ†• Task 2 (template, committed)
â””â”€â”€ README.md                      # ğŸ”„ Updated (Supabase setup instructions)
```

**DetektÃ¡lt eltÃ©rÃ©sek Ã©s indoklÃ¡s:** Nincs eltÃ©rÃ©s - Supabase CLI `npx supabase init` automatikusan generÃ¡lja a helyes struktÃºrÃ¡t.

### Learnings from Previous Story

**From Story 1.1 (Status: done)**

Story 1.1 successfully established the Next.js 15 project foundation. Key learnings for Story 1.2:

**New Patterns/Services Created (Reuse, not recreate):**
- âœ… **Project structure:** src/app/, src/components/, src/lib/, src/services/, src/types/ already exist
- âœ… **Path aliases:** `@/*` configured in tsconfig.json â†’ use `import { createClient } from '@/lib/supabase/client'`
- âœ… **TypeScript strict mode:** Enabled â†’ ensure Supabase types are strictly typed
- âœ… **Package.json scripts:** `npm run dev`, `npm run build` â†’ add `supabase:start`, `supabase:stop` scripts

**Files Modified in Story 1.1 (understand current state):**
- `.env.local` does not exist yet â†’ create in Task 2
- `src/types/index.ts` exists as placeholder â†’ update with Supabase type exports in Task 5
- `README.md` exists with basic setup â†’ extend with Supabase setup instructions in Task 6

**Architectural Decisions from Story 1.1:**
- Supabase client packages already installed: `@supabase/supabase-js ^2.83.0`, `@supabase/ssr ^0.7.0`
- No need to reinstall, proceed with Supabase init

**Technical Debt from Story 1.1:**
- None identified in Story 1.1 review

**Warnings for Story 1.2:**
- âš ï¸ **Environment variables:** `.env.local` must NOT be committed (verify .gitignore has `.env*`)
- âš ï¸ **Supabase service role key:** NEVER expose in client-side code (use only in server.ts, Route Handlers)
- âš ï¸ **Migration naming:** Use timestamp prefix (YYYYMMDDHHMMSS_description.sql) for correct ordering

**Review Findings from Story 1.1 (apply to this story):**
- âœ… Update ALL task checkboxes immediately when completed
- âœ… Document all created files in File List section
- âœ… Test TypeScript compilation before committing

[Source: docs/sprint-artifacts/1-1-project-initialization-core-dependencies.md#Dev-Agent-Record]

### References

**Architecture Document:**
- [Source: docs/architecture.md Â§ Supabase Setup (lines 399-407)] - Supabase client pattern, Auth + Storage integration
- [Source: docs/architecture.md Â§ Data Architecture (lines 1119-1233)] - Core entities schema (agencies, users, brands, posts)
- [Source: docs/architecture.md Â§ ADR-002: Supabase over Firebase/AWS] - Technology decision rationale

**Tech Spec Epic 1:**
- [Source: docs/sprint-artifacts/tech-spec-epic-1.md Â§ Story 1.2 Acceptance Criteria (lines 1115-1127)] - Authoritative AC list
- [Source: docs/sprint-artifacts/tech-spec-epic-1.md Â§ Data Models and Contracts (lines 182-320)] - Complete database schema with constraints
- [Source: docs/sprint-artifacts/tech-spec-epic-1.md Â§ Test Strategy Summary (line 1417)] - Story 1.2 testing approach (~70% coverage target)

**PRD Requirements:**
- [Source: docs/prd-creaitor-2025-11-18/ta2-technology-stack-decisions-p0.md Â§ TA2.2 Backend Stack] - Supabase PostgreSQL + Auth + Storage
- [Source: docs/prd-creaitor-2025-11-18/ta3-data-model-single-source-of-truth.md Â§ TA3.1 Core Entities] - Database schema requirements
- [Source: docs/prd-creaitor-2025-11-18/fr9-data-model-summary-p0-core-entities.md] - Entity relationships and constraints

**Epic 1 Story Breakdown:**
- [Source: docs/epics/epic-1-foundation-development-infrastructure.md Â§ Story 1.2] - Story overview and technical notes

**Previous Story:**
- [Source: docs/sprint-artifacts/1-1-project-initialization-core-dependencies.md] - Story 1.1 implementation learnings

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

<!-- Debug logs will be added during implementation -->

### Completion Notes List

<!-- Implementation notes will be added during story execution -->

### File List

<!-- File changes will be documented during implementation -->

## Change Log

- **2025-11-19:** Story drafted by SM agent (Bob)
