<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>2</storyId>
    <title>Supabase Project Setup &amp; Configuration</title>
    <status>drafted</status>
    <generatedAt>2025-11-19</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-2-supabase-project-setup-configuration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>Supabase local instance configured with PostgreSQL database, Auth service, and Storage</iWant>
    <soThat>we have a working database backend for multi-tenant data and authentication</soThat>
    <tasks>
      - Task 1: Supabase CLI telepítése és inicializálás (AC: #1, #2) - 6 subtasks
      - Task 2: Environment variables setup (AC: #3) - 7 subtasks
      - Task 3: Supabase client singleton implementation (AC: #4) - 6 subtasks
      - Task 4: Initial database schema migration (AC: #5) - 7 subtasks
      - Task 5: TypeScript type generation (AC: #5) - 4 subtasks
      - Task 6: Validation és documentation (AC: #1, #2, #3, #4, #5) - 6 subtasks
    </tasks>
  </story>

  <acceptanceCriteria>
    AC1: Lokális Supabase instance fut PostgreSQL database-zel (localhost:54322), Auth service-szel (Supabase Auth), Storage service-szel (S3-compatible storage), Supabase Studio dashboard accessible (http://localhost:54323)

    AC2: `supabase/` directory struktúra létezik: migrations/ (database migration fájlok), seed.sql (test seed data, optional placeholder), config.toml (Supabase config, generated by `supabase init`)

    AC3: Environment variables konfigurálva `.env.local` fájlban: NEXT_PUBLIC_SUPABASE_URL (Supabase project URL, local: http://localhost:54321), NEXT_PUBLIC_SUPABASE_ANON_KEY (public anon key, safe for client-side), SUPABASE_SERVICE_ROLE_KEY (service role key, server-side only, secret)

    AC4: Supabase client singleton létrehozva `src/lib/supabase/` mappában: client.ts (browser-side client, SSR support with @supabase/ssr), server.ts (server-side client for Route Handlers, Server Actions), middleware.ts (auth middleware for Next.js middleware integration)

    AC5: Initial database schema migration (001_initial_schema.sql) létezik: Tables created (agencies, users, brands, brand_brain_entries, social_profiles, posts, usage_events), Enums created (post_status, usability_rating), Indexes created (idx_posts_brand_id, idx_posts_status, idx_posts_scheduled_at, idx_brands_agency_id, idx_users_agency_id), RLS policies (schema tartalmazza RLS policy placeholder-eket, de DISABLED - Epic 2-ben enablelve), Migration applied successfully (`npx supabase db push` local)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Foundation &amp; Development Infrastructure</title>
        <section>Story 1.2 Acceptance Criteria</section>
        <snippet>Authoritative AC lista Story 1.2-hez. AC1: Lokális Supabase instance fut PostgreSQL database-zel, Auth service-szel, Storage service-szel. AC2: supabase/ directory struktúra létezik (migrations/, seed.sql, config.toml). AC3: .env.local fájl tartalmazza a Supabase connection variables-t. AC4: Supabase client singleton létrehozva src/lib/supabase.ts-ben. AC5: Initial database schema migration létezik core entities-szel (agencies, users, brands, posts, stb.).</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Foundation &amp; Development Infrastructure</title>
        <section>Data Models and Contracts</section>
        <snippet>Complete initial database schema with all tables, enums, indexes, and RLS policy placeholders. Tables: agencies (multi-tenant root), users (extends auth.users), brands, brand_brain_entries, social_profiles, posts (with AI rating constraint), usage_events. Enums: post_status, usability_rating. Indexes: idx_posts_brand_id, idx_posts_status, idx_posts_scheduled_at, idx_brands_agency_id, idx_users_agency_id. RLS policies DISABLED in Epic 1 (enabled in Epic 2).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Creaitor Architecture Document</title>
        <section>Supabase Setup</section>
        <snippet>Supabase architektúra döntések: Database PostgreSQL 15 (Supabase managed), Auth Supabase Auth (email/password + OAuth providers), Storage S3-compatible object storage, Real-time Supabase Realtime (opcionális), Row Level Security (RLS) multi-tenant data isolation. Connection pattern: Client-side @supabase/supabase-js + @supabase/ssr, Server-side Server Actions és Route Handlers.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Creaitor Architecture Document</title>
        <section>Data Architecture - Core Entities</section>
        <snippet>Initial database schema migration definíciója core entities-szel: agencies (UUID PK, name, timestamps), users (UUID PK references auth.users, agency_id FK, email, full_name, role), brands (UUID PK, agency_id FK, name, description, is_active, timestamps), brand_brain_entries (UUID PK, brand_id FK UNIQUE, tone_of_voice, key_messages[], example_posts[], visual_direction, taboos[]), social_profiles (UUID PK, brand_id FK, platform, platform_user_id, access_token encrypted, token_expires_at), posts (UUID PK, brand_id FK, created_by FK, content fields, AI metadata, publishing fields, error handling, AI rating CHECK constraint), usage_events (UUID PK, user_id FK, agency_id FK, event_type, event_metadata JSONB, created_at). Indexes és RLS policy placeholder-ek definiálva.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Creaitor Architecture Document</title>
        <section>ADR-002: Supabase over Firebase/AWS</section>
        <snippet>Architecture decision rationale: Supabase PostgreSQL relational DB választás multi-tenant RLS support miatt, Auth + Storage beépítve, PostgreSQL 15 modern features (JSON support, ACID transactions). Alternatívák elutasítása: Firebase (NoSQL, nehézkes multi-tenant), AWS (komplex setup, magasabb cost). Supabase self-hosted deployment opcióval cost-effective.</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-1-foundation-development-infrastructure.md</path>
        <title>Epic 1: Foundation &amp; Development Infrastructure</title>
        <section>Story 1.2</section>
        <snippet>As a developer, I want Supabase project initialized with local development environment, so that we have database, authentication, and storage infrastructure ready. Technical Notes: Run npx supabase init, run npx supabase start for local development, use Supabase auth-helpers-nextjs for Next.js integration, Row Level Security (RLS) policies will be added in Epic 2.</snippet>
      </doc>
      <doc>
        <path>docs/prd-creaitor-2025-11-18/ta2-technology-stack-decisions-p0.md</path>
        <title>TA2: Technology Stack Decisions (P0)</title>
        <section>TA2.2 Backend Stack</section>
        <snippet>Backend stack döntések: Node.js 20 LTS, TypeScript strict mode, Supabase PostgreSQL + Auth + Storage (P0 választás). Supabase Auth email/password + OAuth providers support. Session store: PostgreSQL-backed (idempotent, persistent, P0 mandatory - NOT MemoryStore). Supabase PostgreSQL managed hosting egyszerű setup és auto backup miatt.</snippet>
      </doc>
      <doc>
        <path>docs/prd-creaitor-2025-11-18/ta3-data-model-single-source-of-truth.md</path>
        <title>TA3: Data Model (Single Source of Truth)</title>
        <section>TA3.1 Core Entities</section>
        <snippet>Autoritatív adatmodell definíció core entities-szel: Agency (id UUID PK, name, timestamps), User (id UUID PK, agency_id FK, email, password_hash, role, timestamps), Brand (id UUID PK, agency_id FK, name, description, fb_page_id, ig_account_id, brand_brain JSON, timestamps), Post (id UUID PK, brand_id FK, user_id FK, text, platform, status, ai_generated, usability_rating, image_url, scheduled_at, published_at, meta_post_id, error_message, publishing_lock, timestamps), Event (id UUID PK, user_id FK, event_type, event_data JSON, timestamp). Brand Brain v1 struktúra definiálva JSON formátumban (tone_of_voice, key_messages[], reference_posts[], visual_direction).</snippet>
      </doc>
      <doc>
        <path>docs/test-design-system.md</path>
        <title>Rendszer-szintű Tesztelési Terv</title>
        <section>Teszt Szintek Stratégia</section>
        <snippet>Test coverage targets: Unit tests 40% (üzleti logika, szolgáltatás mockok), Integration tests 30% (API útvonalak, adatbázis műveletek), E2E tests 30% (kritikus felhasználói útvonalak). Story 1.2 testing: Unit tests Supabase client config validálás (~40% coverage), Integration tests Supabase connection test, DB schema validálás (~70% coverage), E2E tests nincs (még nincs feature UI). Manual testing checklist: Supabase local services running, database migration applied, Supabase client connection test, TypeScript types generated.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/1-1-project-initialization-core-dependencies.md</path>
        <title>Story 1.1: Project Initialization &amp; Core Dependencies</title>
        <section>Learnings from Previous Story</section>
        <snippet>Story 1.1 successfully established Next.js 15 project foundation. Key learnings: Project structure (src/app/, src/components/, src/lib/, src/services/, src/types/ already exist), Path aliases (@/* configured in tsconfig.json), TypeScript strict mode enabled, Package.json scripts (npm run dev, npm run build), Supabase client packages already installed (@supabase/supabase-js ^2.83.0, @supabase/ssr ^0.7.0). Warnings: .env.local must NOT be committed (verify .gitignore), Supabase service role key NEVER expose in client-side code, Migration naming use timestamp prefix for correct ordering.</snippet>
      </doc>
    </docs>
    <code>
      <!-- No existing Supabase client code - Story 1.2 creates src/lib/supabase/ directory with client.ts, server.ts, middleware.ts -->
      <!-- Story 1.1 established base project structure: src/lib/utils.ts exists, src/types/index.ts exists as placeholder -->
    </code>
    <dependencies>
      <node>
        <framework name="Next.js" version="^15.0.0" />
        <framework name="React" version="^18.3.0" />
        <language name="TypeScript" version="^5.3.0" />
        <database name="@supabase/supabase-js" version="^2.83.0" />
        <database name="@supabase/ssr" version="^0.7.0" />
        <devDep name="supabase" version="latest" />
        <devDep name="@types/node" version="^20.10.6" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    - Supabase Client Pattern: MUST use @supabase/ssr for SSR support with Next.js 15 App Router. Browser-side client uses createBrowserClient(), server-side client uses createServerClient() with cookies() from next/headers, middleware uses createMiddlewareClient().
    - Environment Variables: MUST store Supabase connection details in .env.local (NOT committed to git). NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY are safe for client-side, SUPABASE_SERVICE_ROLE_KEY is SECRET and MUST only be used server-side (Route Handlers, Server Actions).
    - Database Schema: MUST use UUID primary keys (not auto-increment integers), TIMESTAMPTZ for all timestamp fields (UTC storage), foreign keys with appropriate cascade delete (brand_brain_entries → brands ON DELETE CASCADE, posts → brands), CHECK constraint for mandatory AI rating (is_ai_generated = true requires ai_usability_rating IS NOT NULL).
    - Migration Naming: MUST use timestamp prefix format (YYYYMMDDHHMMSS_description.sql) for correct migration ordering. Supabase CLI generates timestamp automatically with `npx supabase migration new description`.
    - RLS Policy Strategy: Schema migration MUST include RLS policy SQL as PLACEHOLDER (commented out or DISABLED). RLS policies are NOT enabled in Epic 1 - they are enabled in Epic 2 (Story 2.3). Rationale: Epic 1 infrastructure setup, Epic 2 authentication &amp; authorization.
    - TypeScript Types: MUST generate types from database schema using `npx supabase gen types typescript --local > src/types/database.types.ts`. Manual type exports in src/types/index.ts for enums (PostStatus, UsabilityRating, UserRole, Platform).
    - Supabase Directory Structure: MUST use supabase/ directory (created by `npx supabase init`) with migrations/ subdirectory, config.toml (auto-generated), seed.sql (optional placeholder). Do NOT manually create supabase/ directory structure.
    - Local Development: MUST use `npx supabase start` for local Supabase instance. Services run on: PostgreSQL port 54322, Supabase Studio port 54323, API port 54321. Connection URL: http://localhost:54321.
  </constraints>

  <interfaces>
    <!-- No existing interfaces - Story 1.2 creates Supabase client interfaces -->
    <!-- Supabase client functions will be created: createClient() (browser-side), createServerSupabaseClient() (server-side), createMiddlewareClient() (middleware) -->
  </interfaces>

  <tests>
    <standards>
      Story 1.2 testing follows Tech Spec § Test Strategy Summary és Test Design System § Teszt Szintek Stratégia. Unit tests Supabase client config validálás (~40% coverage target): validate client.ts, server.ts, middleware.ts export correct functions, verify environment variables are loaded. Integration tests Supabase connection test és DB schema validálás (~70% coverage target): test Supabase client connection (GET /api/test-db route), verify database schema migration applied (tables, enums, indexes exist), query test SELECT * FROM agencies LIMIT 1 (should return empty array, no errors). E2E tests nincs (még nincs feature UI). Manual testing checklist: Supabase local services running (`npx supabase status`), database migration applied (tables visible in Supabase Studio), Supabase client connection test (test API route returns data), TypeScript types generated (`npx tsc --noEmit` no errors), TypeScript compilation verification.
    </standards>
    <locations>
      tests/unit/ (for unit tests - to be created in Story 1.4)
      tests/integration/ (for integration tests - to be created in Story 1.4)
      tests/e2e/ (for E2E tests - to be created in Story 1.4)
      src/app/api/test-db/route.ts (validation test route - created in Story 1.2 Task 6)
    </locations>
    <ideas>
      - AC1 Test: Verify Supabase local services running (PostgreSQL port 54322, Studio port 54323) - Integration test (manual or automated health check)
      - AC1 Test: Verify Supabase Studio dashboard accessible at http://localhost:54323 - Manual test
      - AC2 Test: Verify supabase/ directory structure exists (migrations/, config.toml) - Unit test (file system check)
      - AC3 Test: Verify .env.local contains required Supabase environment variables (NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY) - Unit test (environment variable validation)
      - AC3 Test: Verify .env.example exists as template (without actual keys) - Unit test (file existence check)
      - AC4 Test: Verify src/lib/supabase/client.ts exports createClient() function - Unit test (import test)
      - AC4 Test: Verify src/lib/supabase/server.ts exports createServerSupabaseClient() function - Unit test (import test)
      - AC4 Test: Verify src/lib/supabase/middleware.ts exports createMiddlewareClient() function - Unit test (import test)
      - AC5 Test: Verify initial database schema migration exists (001_initial_schema.sql or timestamp-prefixed name) - Unit test (file existence check)
      - AC5 Test: Verify database tables created (agencies, users, brands, brand_brain_entries, social_profiles, posts, usage_events) - Integration test (SQL query: SELECT table_name FROM information_schema.tables WHERE table_schema = 'public')
      - AC5 Test: Verify database enums created (post_status, usability_rating) - Integration test (SQL query: SELECT typname FROM pg_type WHERE typtype = 'e')
      - AC5 Test: Verify database indexes created (idx_posts_brand_id, idx_posts_status, idx_posts_scheduled_at, idx_brands_agency_id, idx_users_agency_id) - Integration test (SQL query: SELECT indexname FROM pg_indexes WHERE schemaname = 'public')
      - AC5 Test: Verify migration applied successfully (test query: SELECT * FROM agencies LIMIT 1 returns empty array, no errors) - Integration test (GET /api/test-db route)
      - Manual Test: Run `npx supabase start` and verify all services start successfully
      - Manual Test: Open Supabase Studio at http://localhost:54323 and verify dashboard loads
      - Manual Test: Run `npx supabase db push` and verify migration applies without errors
      - Manual Test: Run `npx supabase gen types typescript --local > src/types/database.types.ts` and verify types generated
      - Manual Test: Run `npx tsc --noEmit` and verify no TypeScript compilation errors
      - Manual Test: Test Supabase client connection via GET /api/test-db route (should return success response)
    </ideas>
  </tests>
</story-context>

